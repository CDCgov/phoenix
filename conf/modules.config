/*
========================================================================================
    Config file for defining DSL2 per module options and publishing paths
========================================================================================
    Available keys to override module options:
        ext.args            = Additional arguments appended to command in module.
        ext.args2           = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3           = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix          = File name prefix for output files.
----------------------------------------------------------------------------------------
*/


///////////////////////////////////////
//
// workflow: phoenix
//
///////////////////////////////////////

process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    withName: CORRUPTION_CHECK {
        publishDir = [
            [
                path: { "${params.outdir}/${meta.id}" },
                mode: 'copy',
                pattern: "*{.synopsis,_summaryline.tsv}"
            ],
            [
                path: { "${params.outdir}/${meta.id}/file_integrity" },
                mode: 'copy',
                pattern: "*{_summary.txt}",
            ]
        ]
    }

    withName: ASSET_CHECK {
        publishDir = [enabled: false]
    }

    withName: GET_RAW_STATS {
        publishDir = [
            [
                path: { "${params.outdir}/${meta.id}/raw_stats" },
                mode: 'copy',
                pattern: "*{_raw_read_counts.txt}"
            ],
            [
                path: { "${params.outdir}/${meta.id}" },
                mode: 'copy',
                pattern: "*{.synopsis,_summaryline.tsv}"
            ],
            [
                path: { "${params.outdir}/${meta.id}/file_integrity" },
                mode: 'copy',
                pattern: "*{_summary.txt}"
            ]
        ]
    }

    withName: BBDUK {
        ext.args = 'hdist=1 k=31'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/qc_stats" },
            mode: 'copy',
            pattern: "*.log"
        ]
    }

    withName: FASTQCTRIMD {
        ext.args = '--quiet'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/qc_stats" },
            mode: 'copy',
            pattern: "*.{html,zip}"
        ]
    }

    withName: FASTP_TRIMD {
        ext.args = '--cut_right --cut_right_window_size 20 --cut_right_mean_quality 30 --length_required 50 --trim_poly_g --cut_front 20 --cut_tail 20'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/fastp_trimd" },
            mode: 'copy',
            pattern: "*.{trim.fastq.gz,json,html}"
        ]
    }

    withName: FASTP_SINGLES {
        ext.args = '--disable_adapter_trimming'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/fastp_trimd" },
            mode: 'copy',
            pattern: "*.{singles.fastq.gz,json,html}"
        ]
    }

    withName: GET_TRIMD_STATS {
        publishDir = [
            [
            path: { "${params.outdir}/${meta.id}/qc_stats" },
            mode: 'copy',
            pattern: "*{_trimmed_read_counts.txt}"
            ],
            [
                path: { "${params.outdir}/${meta.id}" },
                mode: 'copy',
                pattern: "*{.synopsis,_summaryline.tsv}"
            ],
            [
                path: { "${params.outdir}/${meta.id}/file_integrity" },
                mode: 'copy',
                pattern: "*{_summary.txt}"
            ]
        ]
    }

    withName: SRST2_AR {
        ext.args = '--forward _1.trim --reverse _2.trim --save_scores --report_all_consensus > srst2.log'
        ext.errorStrategy = { "ignore" }
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/srst2"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/srst2"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/srst2"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/srst2"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/srst2"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*_fullgenes__ResGANNCBI_*_srst2__results.txt"
        ]
    }

    withName: GET_MLST_SRST2 {
        ext.args = ''
        ext.errorStrategy = { "ignore" }
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null  || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/mlst"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/mlst"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/mlst"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*{_getMLST_out.txt}"
        ]
    }

    withName: SRST2_MLST {
        ext.args = '--forward _1.trim --reverse _2.trim --save_scores --report_all_consensus > srst2.log'
        ext.errorStrategy = { "ignore" }
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/mlst"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/mlst"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/mlst"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*_srst2.mlst"
        ]
    }

    withName: CHECK_MLST {
        ext.args = ''
        ext.errorStrategy = { "ignore" }
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/mlst"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/mlst"  // Save to params.indir if defined
                        }
                    } else {
                        ;  // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/mlst"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*{_combined.tsv}"
        ]
    }

    withName: CHECK_MLST_WITH_SRST2 {
        ext.args = ''
        ext.errorStrategy = { "ignore" }
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/mlst"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/mlst"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/mlst"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*{_combined.tsv}"
        ]
    }

    withName: RENAME_FASTA_HEADERS {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/assembly" },
            mode: 'copy',
            pattern: "*.renamed.scaffolds.fa.gz"
        ]
    }

    withName: BBMAP_REFORMAT {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/assembly" },
            mode: 'copy',
            pattern: "*.{scaffolds.fa.gz,log}"
        ]
    }

    withName: SCAFFOLD_COUNT_CHECK {
        publishDir = [
            [
                path: { "${params.outdir}/${meta.id}" },
                mode: 'copy',
                pattern: "*{.synopsis,_summaryline.tsv}"
            ],
            [
                path: { "${params.outdir}/${meta.id}/file_integrity" },
                mode: 'copy',
                pattern: "*{_summary.txt}"
            ]
        ]
    }

    withName: PROKKA {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/annotation" },
            mode: 'copy',
            pattern: "*.{faa,gff,fna}"
        ]
    }

    withName: GET_TAXA_FOR_AMRFINDER {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/AMRFinder"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/AMRFinder"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*_AMRFinder_Organism.csv"
        ]
    }

    withName: AMRFINDERPLUS_RUN {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/AMRFinder"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/AMRFinder"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.{tsv}"
        ]
    }

    withName: 'ABRITAMR|ABRITAMR_REPORT' {
        publishDir = [
            //path: { "${params.outdir}/${meta.id}/AMRFinder" },
            // Need to add in some logic to control 'UPDATER' output locations similar to centars
            path: {
                if (params.input != null || params.input_sra != null) {
                    if (params.outdir != "${launchDir}/phx_output") {
                        return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                    } else {
                        return "${meta.project_id}/${meta.id}/AMRFinder"
                    }
                } else if (params.indir != null) {
                    if (params.outdir != "${launchDir}/AMRFinder") {
                        return "${params.outdir}/${meta.id}/AMRFinder"  // Default path
                    } else {
                        return "${params.indir}/${meta.id}/AMRFinder"  // Save to params.indir if defined
                    }
                } else {
                    ; // Should never be able to get started without input or indir
                }
            },
            mode: 'copy',
            pattern: "*.{txt,amrfinder.out,xlsx}"
        ]
    }

    withName: GAMMA_HV {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/gamma_hv"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/gamma_hv"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/gamma_hv"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/gamma_hv"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/gamma_hv"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.{gamma,psl,gff,fasta}"
        ]
    }

    withName: GAMMA_AR {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/gamma_ar"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/gamma_ar"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/gamma_ar"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/gamma_ar"  // Save to params.indir if defined
                        }
                    } else {
                        ;
                        // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/gamma_ar"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.{gamma,psl,gff,fasta}"
        ]
    }

    withName: GAMMA_PF {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/gamma_pf"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/gamma_pf"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/gamma_pf"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/gamma_pf"  // Save to params.indir if defined
                        }
                    } else {
                        ;
                        // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/gamma_pf"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.{gamma,psl,gff,fasta}"
        ]
    }

    withName: QUAST {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/quast" },
            mode: 'copy',
            pattern: "*.tsv"
        ]
    }

    withName: MASH_DIST {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/ANI/mash_dist" },
            mode: 'copy',
            pattern: "*.txt"
        ]
    }

    withName: DETERMINE_TOP_MASH_HITS {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/ANI/mash_dist" },
            mode: 'copy',
            pattern: "*_best_MASH_hits.txt"
        ]
    }

    withName: FASTANI {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/ANI" },
            mode: 'copy',
            pattern: "*.ani.txt"
        ]
    }

    withName: FORMAT_ANI {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/ANI" },
            mode: 'copy',
            pattern: "*.fastANI.txt"
        ]
    }

    withName: SHIGAPASS {
        publishDir = [
            [
                path: {
                    if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                        if (params.input != null || params.input_sra != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}/ANI"  // Default path
                            } else {
                                return "${meta.project_id}/${meta.id}/ANI"
                            }
                        } else if (params.indir != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}/ANI"  // Default path
                            } else {
                                return "${params.indir}/${meta.id}/ANI"  // Save to params.indir if defined
                            }
                        } else {
                            ;
                            // Should never be able to get started without input or indir
                        }
                    } else {
                        return "${params.outdir}/${meta.id}/ANI"  // Default path
                    }
                },
                mode: 'copy',
                pattern: "*_ShigaPass_summary.csv"
            ],
            [
                path: {
                    if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                        if (params.input != null || params.input_sra != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}"  // Default path
                            } else {
                                return "${meta.project_id}/${meta.id}"
                            }
                        } else if (params.indir != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}"  // Default path
                            } else {
                                return "${params.indir}/${meta.id}"  // Save to params.indir if defined
                            }
                        } else {
                            ;
                            // Should never be able to get started without input or indir
                        }
                    } else {
                        return "${params.outdir}/${meta.id}"  // Default path
                    }
                },
                mode: 'copy',
                pattern: "*.tax"
            ]
        ]
    }

    withName: CHECK_SHIGAPASS_TAXA {
        publishDir = [
            [
                path: {
                    if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                        if (params.input != null || params.input_sra != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}/ANI"  // Default path
                            } else {
                                return "${meta.project_id}/${meta.id}/ANI"
                            }
                        } else if (params.indir != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}/ANI"  // Default path
                            } else {
                                return "${params.indir}/${meta.id}/ANI"  // Save to params.indir if defined
                            }
                        } else {
                            ;
                            // Should never be able to get started without input or indir
                        }
                    } else {
                        return "${params.outdir}/${meta.id}/ANI"  // Default path
                    }
                },
            mode: 'copy',
            pattern: "edited/*.fastANI.txt",
            saveAs: { filename -> filename.replace('edited/', '') }
        ],
        [
            path: {
                    if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                        if (params.input != null || params.input_sra != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}"  // Default path
                            } else {
                                return "${meta.project_id}/${meta.id}"
                            }
                        } else if (params.indir != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}/${meta.id}"  // Default path
                            } else {
                                return "${params.indir}/${meta.id}"  // Save to params.indir if defined
                            }
                        } else {
                            ;
                            // Should never be able to get started without input or indir
                        }
                    } else {
                        return "${params.outdir}/${meta.id}"  // Default path
                    }
                },
            mode: 'copy',
            pattern: "edited/*.tax",
            saveAs: { filename -> filename.replace('edited/', '') }
        ]
    ]
}

    withName: DETERMINE_TAXA_ID {
        publishDir = [
            path: { "${params.outdir}/${meta.id}" },
            mode: 'copy',
            pattern: "*.tax"
        ]
    }

    withName: MLST {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/mlst"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/mlst"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/mlst"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/mlst"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.tsv"
        ]
    }

    withName: BUSCO {
        ext.args = '--mode genome'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/BUSCO" },
            mode: 'copy',
            pattern: "*.{txt,json,bam}"
        ]
    }

    withName: CALCULATE_ASSEMBLY_RATIO {
        publishDir = [
            path: { 
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*{_Assembly_ratio_*.txt,_GC_content_*.txt}"
        ]
    }

    withName: CREATE_SUMMARY_LINE {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*_summaryline.tsv"
        ]
    }

    withName: FETCH_FAILED_SUMMARIES {
        publishDir = [
            path: { "${params.outdir}/${meta.id}" },
            mode: 'copy',
            pattern: "*_summaryline.tsv"
        ]
    }

    // Need to edit publish dir. Testing adding CENTAR_GATHER here and commenting it out below since it didnt have ANY logic
    withName: 'GATHER_SUMMARY_LINES|CENTAR_GATHER_SUMMARY_LINES' {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}"  // Default path
                        } else {
                            return "${meta.full_project_id}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}"  // Default path
                        } else {
                            return "${params.indir}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*hoenix_Summary.tsv"
        ]
    }

    withName: 'GRIPHIN|CLIA_GRIPHIN' {
        publishDir = [
            path: { "${params.outdir}" },
            mode: 'copy',
            pattern: "{*_Summary.xlsx,*_Summary.tsv,Directory_samplesheet.csv}"
        ]
    }

    withName: 'CREATE_CLIA_PDF' {
        publishDir = [
            path: { "${params.outdir}" },
            mode: 'copy',
            pattern: "*{.pdf,.html}"
        ]
    }

    withName: CREATE_NCBI_UPLOAD_SHEET {
        publishDir = [
            path: { "${params.outdir}" },
            mode: 'copy',
            pattern: "*{*.xlsx}"
        ]
    }

    withName: 'CUSTOM_DUMPSOFTWAREVERSIONS|COMBINE_CUSTOM_DUMPSOFTWAREVERSIONS|UPDATER_CUSTOM_DUMPSOFTWAREVERSIONS|CENTAR_CUSTOM_DUMPSOFTWAREVERSIONS' {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    // Determine the suffix based on mode
                    String info_dir = switch(params.mode_upper) {
                                            case "CENTAR" -> "centar_pipeline_info"
                                            case "UPDATE_PHOENIX" -> "update_pipeline_info" }
                    if (params.input != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${info_dir}"  // Default path
                        } else {
                            return "${meta.full_project_id}/${info_dir}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${info_dir}"  // Default path
                        } else {
                            return "${params.indir}/${info_dir}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/pipeline_info"  // Default path
                }
            },
            mode: 'copy',
            pattern: '*_versions.yml'
        ]
    }
}

///////////////////////////////////////
//
// Subworkflow: spades
//
///////////////////////////////////////

process {

    withName: SPADES {
        errorStrategy = "ignore"
        //ext.args = '--isolate'
        publishDir = [
            [
                path: { "${params.outdir}/${meta.id}/assembly" },
                mode: 'copy',
                pattern: "*.{scaffolds.fa.gz,contigs.fa.gz,transcripts.fa.gz,gene_clusters.fa.gz,assembly.gfa.gz,log}"
            ],
            [
                path: { "${params.outdir}/${meta.id}/file_integrity" },
                mode: 'copy',
                pattern: "*{_trimstats_summary.txt}"
            ]
        ]
    }

    withName: DETERMINE_TAXA_ID_FAILURE {
        publishDir = [
            path: { "${params.outdir}/${meta.id}" },
            mode: 'copy',
            pattern: "*.tax"
        ]
    }

    withName: CREATE_SUMMARY_LINE_FAILURE {
        publishDir = [
            path: { "${params.outdir}/${meta.id}" },
            mode: 'copy',
            pattern: "*_summaryline.tsv"
        ]
    }

    withName: GENERATE_PIPELINE_STATS_FAILURE {
        publishDir = [
            path: { "${params.outdir}/${meta.id}" },
            mode: 'copy',
            pattern: "*.synopsis"
        ]
    }

    withName: GENERATE_PIPELINE_STATS_FAILURE_EXQC {
        publishDir = [
            path: { "${params.outdir}/${meta.id}" },
            mode: 'copy',
            pattern: "*.synopsis"
        ]
    }

}

///////////////////////////////////////
//
// Subworkflow: kraken to krona
//
///////////////////////////////////////

process {

    withName: KRAKEN2_TRIMD {
        ext.args = '--use-names'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_trimd" },
            mode: 'copy',
            pattern: "*.summary.txt"
        ]
    }

    withName: KRAKEN2_BH_TRIMD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_trimd" },
            mode: 'copy',
            pattern: "*.top_kraken_hit.txt"
        ]
    }

    withName: KREPORT2MPA_TRIMD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_trimd" },
            mode: 'copy',
            pattern: "*.mpa"
        ]
    }

    withName: KREPORT2KRONA_TRIMD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_trimd/krona" },
            mode: 'copy',
            pattern: "*.krona"
        ]
    }

    withName: KRONA_KTIMPORTTEXT_TRIMD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_trimd/krona" },
            mode: 'copy',
            pattern: "*.html"
        ]
    }
        withName: KRAKEN2_ASMBLD {
        ext.args = '--use-names'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld" },
            mode: 'copy',
            pattern: "*.summary.txt"
        ]
    }

    withName: KREPORT2MPA_ASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld" },
            mode: 'copy',
            pattern: "*.mpa"
        ]
    }

    withName: KREPORT2KRONA_ASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld/krona" },
            mode: 'copy',
            pattern: "*.krona"
        ]
    }

    withName: KRONA_KTIMPORTTEXT_ASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld/krona" },
            mode: 'copy',
            pattern: "*.html"
        ]
    }

    withName: KRAKEN2_BH_ASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld" },
            mode: 'copy',
            pattern: "*.top_kraken_hit.txt"
        ]
    }

    withName: KRAKEN2_WTASMBLD {
        publishDir = [enabled: false]
    }

    withName: KRAKENTOOLS_MAKEKREPORT {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld_weighted" },
            mode: 'copy',
            pattern: "*_wtasmbld.summary.txt"
        ]
    }

    withName: KREPORT2KRONA_WTASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld_weighted/krona" },
            mode: 'copy',
            pattern: "*.krona"
        ]
    }

    withName: KRONA_KTIMPORTTEXT_WTASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld_weighted/krona" },
            mode: 'copy',
            pattern: "*.html"
        ]
    }

    withName: KRONA_KTIMPORTTEXT_WTASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld_weighted/krona" },
            mode: 'copy',
            pattern: "*.html"
        ]
    }

    withName: KRAKEN2_BH_WTASMBLD {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/kraken2_asmbld_weighted" },
            mode: 'copy',
            pattern: "*.top_kraken_hit.txt"
        ]
    }
}


///////////////////////////////////////
//
// Subworkflow: generating pipeline stats
//
///////////////////////////////////////


process {

    withName: GENERATE_PIPELINE_STATS {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.synopsis"
        ]
    }

}

///////////////////////////////////////
//
// workflow: scaffolds and cdc_scaffolds
//
///////////////////////////////////////

process {

    withName: "SAMPLESHEET_CHECK|CENTAR_SAMPLESHEET_CHECK" {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                //if (params.mode_upper == "UPDATE_PHOENIX") {
                    // Determine the suffix based on mode
                    String info_dir = switch(params.mode_upper) {
                                            case "CENTAR" -> "centar_pipeline_info"
                                            case "UPDATE_PHOENIX" -> "update_pipeline_info" }
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${info_dir}"  // Default path
                        } else {
                            return "${meta.full_project_id}/${info_dir}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${info_dir}"  // Default path
                        } else {
                            return "${params.indir}/${info_dir}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/pipeline_info"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.valid.csv"
        ]
    }

    withName: CREATE_SAMPLESHEET {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                    // Determine the suffix based on mode
                    String info_dir = switch(params.mode_upper) {
                                            case "CENTAR" -> "centar_pipeline_info"
                                            case "UPDATE_PHOENIX" -> "update_pipeline_info" }
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${info_dir}"  // Default path
                        } else {
                            return "${meta.full_project_id}/${info_dir}" // This likely doesnt work as expected...
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${info_dir}"  // Default path
                        } else {
                            return "${params.indir}/${info_dir}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/pipeline_info"  // Default path
                }
            },
            mode: 'copy',
            pattern: "GRiPHin_samplesheet_created.csv"
        ]
    }
}

///////////////////////////////////////
//
// workflow: sra
//
///////////////////////////////////////

process {

    withName: SRATOOLS_PREFETCH {
        publishDir = [enabled: false]
    }

    withName: SRATOOLS_FASTERQDUMP {
        publishDir = [enabled: false]
    }

    withName: ENTREZDIRECT_ESEARCH {
        publishDir = [enabled: false]
    }

    withName: RENAME_SRA_FASTA {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/raw_fastqs" },
            mode: 'copy',
            pattern: '*_R*_001.fastq.gz'
        ]
    }

    withName: CREATE_SRA_SAMPLESHEET {
        publishDir = [ path: { "${params.outdir}" },
            mode: 'copy',
            pattern: 'sra_samplesheet.csv'
        ]
    }

}


///////////////////////////////////////
//
// workflow: updater
//
///////////////////////////////////////


process {

    withName: CREATE_AND_UPDATE_README {
        publishDir = [
            path: { 
                    if (params.input != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else if (params.indir != null) {
                            return "${params.indir}/${meta.id}"  // Save to params.indir if defined
                        } else {
                            return "${meta.project_id}/${meta.id}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                },
            mode: 'copy',
            pattern: "edited/*_updater_log.tsv",
            saveAs: { filename -> filename.replace('edited/', '') }
        ]
    }

    withName: COLLECT_SAMPLE_FILES {
        publishDir = [enabled: false]
    }

    withName: COLLECT_PROJECT_FILES {
        publishDir = [enabled: false]
    }

    withName: GRIPHIN_NO_PUBLISH {
        publishDir = [enabled: false]
    }

    withName: 'GRIPHIN_PUBLISH' {
        publishDir = [
            path: { 
                    if (params.mode_upper == "CENTAR" || params.mode_upper == "UPDATE_PHOENIX") {
                        if (params.input != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}"  // Default path
                            } else if (params.indir != null) {
                                return "${params.indir}"  // Save to params.indir if defined
                            } else {
                                return "${meta.project_id}"
                            }
                        } else if (params.indir != null) {
                            if (params.outdir != "${launchDir}/phx_output") {
                                return "${params.outdir}"  // Default path
                            } else {
                                return "${params.indir}"  // Save to params.indir if defined
                            }
                        } else {
                            ; // Should never be able to get started without input or indir
                        }
                    }
                },
            mode: 'copy',
            pattern: "{*_Summary.xlsx,*_Summary.tsv,Directory_samplesheet.csv}"
        ]
    }

    withName: UPDATE_GRIPHIN {
        publishDir = [
            path: {
                if (params.input != null || params.input_sra != null) {
                    if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}"  // Default path
                        } else {
                            return "${full_project_id}"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}"  // Default path
                        } else {
                            return "${params.indir}"  // Save to params.indir if defined
                }
                    }
            },
            mode: 'copy',
            pattern: "*{_GRiPHin_Summary.xlsx,_GRiPHin_Summary.tsv,Directory_samplesheet.csv}"
        ]
    }

    withName: CREATE_FAIRY_FILE {
        publishDir = [enabled: false]
    }

}

///////////////////////////////////////
//
// workflow: Centar --> cdiff specific pipeline
//
///////////////////////////////////////

process {

    withName: CENTAR_CREATE_SAMPLESHEET {
        publishDir = [
            path: {
                if (params.outdir != null) {
                    return "${params.outdir}/centar_pipeline_info"  // Default path
                } else if (params.indir != null) {
                    return "${params.indir}/centar_pipeline_info"  // Save to params.indir if defined
                } else if (params.input != null || params.input_sra != null) {
                    return "${project_id}/centar_pipeline_info" }},
            mode: 'copy',
            pattern: "GRiPHin_samplesheet_created.csv"
        ]
    }

    withName: CDIFF_CLADE {
        publishDir = [
            // Checks are done in entry points to guarantee that input CANNOT be NULL. Will
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/clade"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR/clade"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/clade"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR/clade"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR/clade"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.tsv"
        ]
    }

    withName: CDIFF_TOX_GENES {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/gamma_tox"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR/gamma_tox"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/gamma_tox"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR/gamma_tox"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR/gamma_tox"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.{gamma,psl,gff,fasta}"

        ]
    }

    withName: CDIFF_TOXINOTYPER {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/toxinotyper"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR/toxinotyper"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/toxinotyper"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR/toxinotyper"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR/toxinotyper"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*{.tox,psl}"
        ]
    }

    withName: CDIFF_RIBOTYPER {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/ML_ribotype"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR/ML_ribotype"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/ML_ribotype"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR/ML_ribotype"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR/ML_ribotype"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.tsv"
        ]
    }

    withName: WGMLST {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/ML_ribotype"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR/ML_ribotype"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/ML_ribotype"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR/ML_ribotype"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR/ML_ribotype"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.tsv"
        ]
    }

    withName: CDIFF_AR_GENES_NT {
        ext.args = '-e'
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR/gamma_ar"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR/gamma_ar"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.{gamma,psl,gff,fasta}"
        ]
    }

    withName: CDIFF_AR_GENES_AA {
        ext.args = '-e'
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR/gamma_ar"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR/gamma_ar"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.{gamma,psl,gff,fasta}"
        ]
    }

    /*withName: CDIFF_AR_GENES_ALL {
        publishDir = [
            path: {
                if (params.input != null || params.input_sra != null) {
                    if (params.outdir != "${launchDir}/phx_output") {
                        return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                    } else {
                        return "${meta.project_id}/${meta.id}/CENTAR/gamma_ar"
                    }
                } else if (params.indir != null) {
                    if (params.outdir != "${launchDir}/phx_output") {
                        return "${params.outdir}/${meta.id}/CENTAR/gamma_ar"  // Default path
                    } else {
                        return "${params.indir}/${meta.id}/CENTAR/gamma_ar"  // Save to params.indir if defined
                    }
                } else {
                    ;
                    // Should never be able to get started without input or indir
                }
            },
            mode: 'copy',
            pattern: "*.{gamma,psl,gff,fasta}"
        ]
    }*/

    withName: CENTAR_CONSOLIDATER {
        publishDir = [
            path: {
                if (params.mode_upper == "CENTAR" || params.centar == true) {
                    if (params.input != null || params.input_sra != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR"  // Default path
                        } else {
                            return "${meta.project_id}/${meta.id}/CENTAR"
                        }
                    } else if (params.indir != null) {
                        if (params.outdir != "${launchDir}/phx_output") {
                            return "${params.outdir}/${meta.id}/CENTAR"  // Default path
                        } else {
                            return "${params.indir}/${meta.id}/CENTAR"  // Save to params.indir if defined
                        }
                    } else {
                        ; // Should never be able to get started without input or indir
                    }
                } else {
                    return "${params.outdir}/${meta.id}/CENTAR"  // Default path
                }
            },
            mode: 'copy',
            pattern: "*.tsv"
        ]
    }

    withName: 'CENTAR_GRIPHIN_INDIR|CENTAR_GRIPHIN_INPUT' {
        publishDir = [
            path: {
                //if given an outdir use it
                if (params.outdir != "${launchDir}/phx_output" && params.griphin_out == "${launchDir}") {
                    return "${params.outdir}"  // Default path
                } else if (params.griphin_out != "${launchDir}") {
                    return "${params.griphin_out}"
                } else if (params.indir != null) {
                     return "${params.indir}"  // Save to params.indir if defined
                } else if (params.input != null) {
                    return "${outdir}" }},
            mode: 'copy',
            pattern: "{*_Summary.xlsx,*_Summary.tsv,Directory_samplesheet.csv}"
        ]
    }

    withName: 'UPDATE_CENTAR_GRIPHIN|UPDATE_CENTAR_GRIPHIN_MULTI_DIR' {
        publishDir = [
            path: {
                if (params.outdir != "${launchDir}/phx_output" && params.griphin_out == "${launchDir}") {
                    return "${params.outdir}"
                } else if (params.griphin_out != "${launchDir}") {
                    return "${params.griphin_out}"
                } else if (params.indir != null) {
                    return "${params.indir}"  // Save to params.indir if defined
                } else {
                    return "${full_project_id}"
                }
            },
            mode: 'copy',
            pattern: "{*_Summary.xlsx,*_Summary.tsv}"
        ]
    }

    withName: 'NO_PUB_CENTAR_GRIPHIN|NO_PUB_CENTAR_GRIPHIN_MULTI_DIR' {
        publishDir = [enabled: false]
    }

}
